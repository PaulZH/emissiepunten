<link rel="import" href="../../bower_components/polymer/polymer.html"/>
<dom-module id="ev-map-location-layer">
<script>Polymer({is:"ev-map-location-layer",properties:{olMap:Object,locationLayer:{type:Object},radiusFeature:{type:Object},markerFeature:{type:Object},location:{type:Object,notify:!0},geolocate:{type:Boolean,notify:!0},geolocationPoint:{type:Array,value:null}},observers:["onLocationChanged(location.*)","onRadiusChanged(location.radius)","onGeolocate(geolocate)"],attached:function(){this.renderLocationLayer(),this.registerMapClicks()},renderLocationLayer:function(){this.locationLayer=new ol.layer.Vector({name:"location",source:new ol.source.Vector({})}),this.olMap.addLayer(this.locationLayer)},registerMapClicks:function(){var t=this;this.olMap.on("singleclick",function(o){t.isMapClick(o)&&t.updateLocationFromPoint(o.coordinate)})},isMapClick:function(t){var o=!0;return this.olMap.forEachFeatureAtPixel(t.pixel,function(t){if(t.get("name").match(/^(site|ep)$/))return o=!1,!0}),o},updateLocationFromPoint:function(t){var o=ol.proj.transform(t,"EPSG:31370","EPSG:4326");this.set("location.point",t),this.set("location.lon",o[0]),this.set("location.lat",o[1])},onLocationChanged:function(){this.debounce("onLocationChanged",function(){this.location&&this.location.point&&(this.getMarkerFeature().getGeometry().setCoordinates(this.location.point),this.getRadiusFeature().getGeometry().setCenterAndRadius(this.location.point,1e3*this.location.radius),this.async(this.transitionToLocation,100))},10)},onRadiusChanged:function(t){t&&this.location.point&&this.async(function(){var t=!0;this.transitionToLocation(t)},100)},getMarkerFeature:function(){return this.markerFeature?this.markerFeature:(this.markerFeature=new ol.Feature({name:"locationMarker",geometry:new ol.geom.Point(this.location.point)}),this.markerFeature.setStyle(new ol.style.Style({image:new ol.style.Icon({anchor:[.5,.5],size:[20,20],src:window.app.base+"src/ev-map-location-layer/img/my-location.png"})})),this.locationLayer.getSource().addFeature(this.markerFeature),this.markerFeature)},getRadiusFeature:function(){if(this.radiusFeature)return this.radiusFeature;this.radiusFeature=new ol.Feature({name:"locationRadius",geometry:new ol.geom.Circle(this.location.point,1e3*this.location.radius)});var t=new ol.style.Style({fill:new ol.style.Fill({color:[77,166,146,.3]})});return this.radiusFeature.setStyle(t),this.locationLayer.getSource().addFeature(this.radiusFeature),this.radiusFeature},transitionToLocation:function(t){var o=this.olMap.getView(),e=ol.animation.pan({source:o.getCenter(),duration:500}),i=o.getResolution(),a=10*this.location.radius,n=ol.animation.zoom({resolution:i,duration:500});i>a||t?(this.olMap.beforeRender(e,n),o.setCenter(this.location.point),o.setResolution(a)):(this.olMap.beforeRender(e),o.setCenter(this.location.point))},onGeolocate:function(){var t=this;return this.geolocate&&this.olMap?this.geolocationPoint?(this.set("geolocate",!1),t.updateLocationFromPoint(this.geolocationPoint)):void(this.geolocation||(this.geolocation=new ol.Geolocation({projection:this.olMap.getView().getProjection()}),this.geolocation.on("change:position",function(){t.set("geolocationPoint",t.geolocation.getPosition()),t.geolocate&&(t.updateLocationFromPoint(t.geolocationPoint),t.set("geolocate",!1))}),this.geolocation.setTracking(!0))):void this.set("geolocate",!1)}})</script>
</dom-module>