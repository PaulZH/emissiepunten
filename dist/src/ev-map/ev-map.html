<link rel="import" href="../../bower_components/polymer/polymer.html"/>
<link rel="import" href="../ev-card/ev-card.html?1.0.9"/>
<link rel="import" href="../openlayers/openlayers-assets.html?1.0.9"/>
<link rel="import" href="../openlayers/openlayers-styles.html?1.0.9"/>
<link rel="import" href="../app/behaviors/app-lazyloading.html?1.0.9"/>
<link rel="import" href="../app/behaviors/app-localization.html?1.0.9"/>
<dom-module id="ev-map">
<template>
<style include="openlayers-styles app-styles">:host{display:block;position:relative}#map-card{--ev-card-content:{height:410px;overflow:hidden};}#map{height:100%;width:100%;overflow:hidden;box-sizing:border-box}#loading{position:absolute;top:0;left:0;width:100%;height:4px;background-color:var(--ev-app-green-1);display:none}#loading.active{display:block;animation:loader 3s infinite ease}@keyframes loader{0%{width:0;left:0}50%{width:100%;left:0}100%{width:0;left:100%}}#error{position:absolute;left:8px;bottom:-50px;background-color:#c00;color:#fff;line-height:32px;padding:0 16px;max-width:50%;transition:bottom 1s ease,opacity 1s ease;opacity:0;z-index:2}#error.active{bottom:8px;opacity:1}</style>
<ev-card id="map-card" title="{{localize('map_title')}}">
<div id="map"></div>
<div id="loading"></div>
<div id="error">{{queryError}}</div>
<template is="dom-if" if="[[deferredElementsLoaded]]">
<ev-radius radius="{{location.radius}}"></ev-radius>
<ev-map-location-layer ol-map="{{olMap}}" location="{{location}}" geolocate="{{geolocate}}"></ev-map-location-layer>
<ev-map-markers-layer ol-map="{{olMap}}" location="{{location}}" sites="{{sites}}" site="{{selectedSite}}" emission-point="{{selectedEmissionPoint}}"></ev-map-markers-layer>
<ev-map-emission-points-overlay ol-map="{{olMap}}" location="{{location}}" site="{{selectedSite}}" emission-point="{{selectedEmissionPoint}}"></ev-map-emission-points-overlay>
</template>
</ev-card>
</template>
<script>Polymer({is:"ev-map",behaviors:[appLazyloading,appLocalization],properties:{title:{type:String},initialCenter:{type:Array,value:[140860.69299028325,190532.7165957574]},mapExtent:{type:Array,value:[9928,66928,272072,329072]},projection:Object,resolutions:Array,matrixIds:Array,olMap:Object,tilesLayer:Object,geolocate:{type:Boolean,notify:!0},location:{type:Object,notify:!0},sites:{type:Array,notify:!0},selectedSite:{type:Object,notify:!0},selectedEmissionPoint:{type:Object,notify:!0},runningQueries:{type:Number,value:0},queryError:String},observers:["onLocationChanged(location.*)","onQueryError(queryError)"],onLocationChanged:function(){if(this.localize){var e=this.$$("ev-card"),t=this.localize("map_title");this.location&&this.location.lat&&(t=this.localize("sites_within","radius",this.location.radius,"lat",this.location.lat.toFixed(5),"lon",this.location.lon.toFixed(5))),e.set("title",t),this.triggerResize()}},attached:function(){this.initProjection(),this.initResolutions(),this.initMatrixIds(),this.renderMap(),this.renderTilesLayer(),this.scopeSubtree(this.$.map,!0),this.async(this.renderDeferredElements,500),window.evMap=this},initProjection:function(){var e="EPSG:31370";if(!ol.proj.get(e)){var t="+proj=lcc +lat_1=51.16666723333333 +lat_2=49.8333339 +lat_0=90 +lon_0=4.367486666666666 +x_0=150000.013 +y_0=5400088.438 +ellps=intl +towgs84=106.869,-52.2978,103.724,-0.33657,0.456955,-1.84218,1 +units=m +no_defs";proj4.defs(e,t)}this.set("projection",ol.proj.get(e))},initResolutions:function(){for(var e=[],t=ol.extent.getHeight(this.mapExtent)/256,i=0;i<12;i++)e[i]=t/Math.pow(2,i);this.set("resolutions",e)},initMatrixIds:function(){for(var e=[],t=0;t<12;t++)e[t]=t.toString();this.set("matrixIds",e)},renderDeferredElements:function(){var e=this;this.lazyload(["../ev-radius/ev-radius.html?1.0.9","../ev-map-location-layer/ev-map-location-layer.html?1.0.9","../ev-map-markers-layer/ev-map-markers-layer.html?1.0.9","../ev-map-emission-points-overlay/ev-map-emission-points-overlay.html?1.0.9"]).then(function(){e.set("deferredElementsLoaded",!0),e.triggerResize()})},renderMap:function(){this.olMap=new ol.Map({target:this.$.map,loadTilesWhileAnimating:!1,interactions:ol.interaction.defaults({mouseWheelZoom:!1}),controls:[new ol.control.ScaleLine,new ol.control.Zoom,new ol.control.ZoomSlider],view:new ol.View({center:this.initialCenter,extent:this.mapExtent,projection:this.projection,resolutions:this.resolutions,zoom:2})})},renderTilesLayer:function(){this.tilesLayer=new ol.layer.Tile({name:"tiles",source:new ol.source.WMTS({url:"https://tile.informatievlaanderen.be/ws/raadpleegdiensten/wmts",layer:"grb_bsk_grijs",matrixSet:"BPL72VL",format:"image/png",projection:"EPSG:31370",tileGrid:new ol.tilegrid.WMTS({extent:this.mapExtent,resolutions:this.resolutions,matrixIds:this.matrixIds}),style:""})}),this.olMap.addLayer(this.tilesLayer)},triggerResize:function(){var e=document.createEvent("HTMLEvents");e.initEvent("resize",!0,!1),window.dispatchEvent(e)},onQueryStarted:function(){var e=this;this.runningQueries++,setTimeout(function(){e.runningQueries&&e.$.loading.classList.add("active")},500)},onQueryEnded:function(){this.runningQueries--,this.runningQueries<=0&&this.$.loading.classList.remove("active")},onQueryError:function(e){if(e){var t=this;this.$.error.classList.add("active"),setTimeout(function(){t.queryError===e&&(t.$.error.classList.remove("active"),setTimeout(function(){t.queryError=null},1e3))},5e3)}}})</script>
</dom-module>