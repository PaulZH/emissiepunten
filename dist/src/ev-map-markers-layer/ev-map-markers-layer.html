
<link rel="import" href="../../bower_components/polymer/polymer.html"/>
<link rel="import" href="../openlayers/openlayers-assets.html?1.5.1"/>
<link rel="import" href="../app/queries/sites-query.html?1.5.1"/>
<link rel="import" href="../app/queries/emission-points-query.html?1.5.1"/>
<link rel="import" href="../app/queries/site-coordinates-query.html?1.5.1"/>
<link rel="import" href="../app/behaviors/app-config.html?1.5.1"/>
<link rel="import" href="../app/behaviors/app-map-helper.html?1.5.1"/>
<dom-module id="ev-map-markers-layer">
<template>
<sites-query location="{{location}}" response="{{sitesResponse}}"></sites-query>
<site-coordinates-query sites="{{basicSites}}" response="{{siteCoordsResponse}}"></site-coordinates-query>
<emission-points-query site="{{site}}" response="{{epsResponse}}"></emission-points-query>
</template>
<script>Polymer({is:"ev-map-markers-layer",behaviors:[appConfig,appMapHelper],properties:{olMap:Object,location:{type:Object,notify:!0},markerLayer:{type:Object},basicSites:{type:Array},sites:{type:Array,notify:!0,observer:"onSitesChanged"},site:{type:Object,notify:!0,observer:"onSiteChanged"},emissionPoint:{type:Object,notify:!0,observer:"onEmissionPointChanged"}},observers:["onLocationChanged(location.*)","onSitesLoaded(sitesResponse)","onEmissionPointsLoaded(epsResponse)","onSiteCoordinatesLoaded(siteCoordsResponse)"],attached:function(){this.renderMarkerLayer(),this.registerMapClicks()},renderMarkerLayer:function(){this.markerLayer=new ol.layer.Vector({name:"sites-eps",source:new ol.source.Vector({})}),this.olMap.addLayer(this.markerLayer)},registerMapClicks:function(){var n=this;this.olMap.on("singleclick",function(e){var t=n.getFeatureAtPixel(e.pixel,"site"),i=n.getFeatureAtPixel(e.pixel,"ep");if(t&&i){var s=t.getStyle().getZIndex();i.getStyle().getZIndex()<s?n.handleSiteFeatureClick(t):n.handleEmissionPointFeatureClick(i)}else t?n.handleSiteFeatureClick(t):i&&n.handleEmissionPointFeatureClick(i)})},onLocationChanged:function(){this.debounce("onLocationChanged",function(){this.location&&this.location.point&&this.$$("sites-query").execute()},10)},onSitesLoaded:function(e){if(!e.bindings.length)return this.set("sites",[]);var i=[];e.bindings.forEach(function(e){if("0"!==e.epCount.value){var t={uri:e.site.value,label:e.siteLabel.value,epCount:e.epCount.value,eps:[]};i.push(t)}}),this.set("basicSites",i),this.async(function(){this.$$("site-coordinates-query").execute()},1)},onSiteCoordinatesLoaded:function(e){var t=this,i={};e.bindings.forEach(function(e){i[e.site.value]=e});var s=[];this.basicSites.forEach(function(e){i[e.uri]&&(e.x=parseFloat(i[e.uri].x.value),e.y=parseFloat(i[e.uri].y.value),t.isWithinRadius([e.x,e.y])&&s.push(e))}),this.set("sites",s)},onSitesChanged:function(e){this.markerLayer&&this.markerLayer.getSource().clear(),e&&this.renderSiteMarkers(e)},renderSiteMarkers:function(e){var t=this.createSiteMarkerFeatures(e);this.markerLayer.getSource().clear(),this.markerLayer.getSource().addFeatures(t),this.stackFeatures()},stackFeatures:function(){var e=this.markerLayer.getSource().getFeatures();this.sortFeaturesByPosition(e),e.forEach(function(e,t){var i="line"===e.get("name")?0:t+1;e.getStyle().setZIndex(i)})},createSiteMarkerFeatures:function(e){var t=this,i=[];return e.forEach(function(e){i.push(t.createSiteFeature(e))}),i},createSiteFeature:function(e){var t=new ol.Feature({name:"site",site:e,geometry:new ol.geom.Point([e.x,e.y]),defaultStyle:new ol.style.Style({image:new ol.style.Icon(this.config("markerStyles").site)}),selectedStyle:new ol.style.Style({image:new ol.style.Icon(this.config("markerStyles").selectedSite)}),currentStyle:"defaultStyle"});return t.setStyle(t.get("defaultStyle")),t},onSiteChanged:function(e){if(this.markerLayer){if(this.deselectSiteFeatures(),this.resetEmissionPointFeatures(),e){var t=this.findFeatureByUri(this.markerLayer,"site",e.uri);t&&(this.selectSiteFeature(t),e.eps.length?this.showEmissionPointFeatures(e):this.loadEmissionPoints(),this.debounce("transitionToSiteFeature",this.transitionToSiteFeature,100))}this.set("emissionPoint",null)}},transitionToSiteFeature:function(){if(this.site){var e=this.olMap.getView(),t=ol.animation.pan({source:e.getCenter(),duration:500});this.olMap.beforeRender(t),e.setCenter([this.site.x,this.site.y])}},deselectSiteFeatures:function(){this.findFeatures(this.markerLayer,"site").forEach(function(e){"defaultStyle"!==e.get("currentStyle")&&this.setFeatureStyle(e,"defaultStyle")},this)},selectSiteFeature:function(e){this.setFeatureStyle(e,"selectedStyle")},handleSiteFeatureClick:function(e){"selectedStyle"===e.get("currentStyle")?this.set("site",null):this.set("site",e.get("site"))},resetEmissionPointFeatures:function(){this.findFeatures(this.markerLayer,["ep","line"]).forEach(function(e){this.setFeatureStyle(e,"defaultStyle")},this)},loadEmissionPoints:function(){this.async(function(){this.$$("emission-points-query").execute()},1)},onEmissionPointsLoaded:function(e){var s=null,n=[],r={};e.bindings.forEach(function(e){s=e.site.value;var t={uri:e.ep.value,label:e.epLabel.value,lon:parseFloat(e.epLon.value),lat:parseFloat(e.epLat.value)};if(!r[t.uri]){r[t.uri]=!0,t.shortLabel=t.label.replace(new RegExp("^"+e.siteLabel.value+"\\s*:\\s*"),"");var i=ol.proj.transform([t.lon,t.lat],"EPSG:4326","EPSG:31370");t.x=i[0],t.y=i[1],n.push(t)}},this),s===this.site.uri&&(this.site.eps=n,this.notifyPath("site.eps"),this.renderEmissionPointMarkers(this.site,n))},renderEmissionPointMarkers:function(t,e){var i=[];e.forEach(function(e){i.push(this.createConnectorFeature(t,e)),i.push(this.createEmissionPointFeature(t,e))},this),this.markerLayer.getSource().addFeatures(i),this.stackFeatures(),this.site&&this.showEmissionPointFeatures(this.site)},createConnectorFeature:function(e,t){var i=[e.x,e.y],s=[t.x,t.y],n=new ol.Feature({name:"line",lineStart:e,siteUri:e.uri,geometry:new ol.geom.LineString([i,s]),defaultStyle:new ol.style.Style({image:""}),visibleStyle:new ol.style.Style({stroke:new ol.style.Stroke(this.config("markerStyles").connector)}),currentStyle:"defaultStyle"});return n.setStyle(n.get("defaultStyle")),n},createEmissionPointFeature:function(e,t){var i=new ol.Feature({name:"ep",ep:t,siteUri:e.uri,geometry:new ol.geom.Point([t.x,t.y]),defaultStyle:new ol.style.Style({image:""}),visibleStyle:new ol.style.Style({image:new ol.style.Icon(this.config("markerStyles").emissionPoint)}),selectedStyle:new ol.style.Style({image:new ol.style.Icon(this.config("markerStyles").selectedEmissionPoint)}),currentStyle:"defaultStyle"});return i.setStyle(i.get("defaultStyle")),i},showEmissionPointFeatures:function(t){this.findFeatures(this.markerLayer,["ep","line"]).forEach(function(e){e.get("siteUri")===t.uri&&this.setFeatureStyle(e,"visibleStyle")},this)},handleEmissionPointFeatureClick:function(e){"selectedStyle"===e.get("currentStyle")?this.set("emissionPoint",null):this.set("emissionPoint",e.get("ep"))},onEmissionPointChanged:function(e){if(this.markerLayer&&(this.deselectEmissionPointFeatures(),e)){var t=this.findFeatureByUri(this.markerLayer,"ep",e.uri);t&&this.selectEmissionPointFeature(t)}},deselectEmissionPointFeatures:function(){this.findFeatures(this.markerLayer,"ep").forEach(function(e){"selectedStyle"===e.get("currentStyle")&&this.setFeatureStyle(e,"visibleStyle")},this)},selectEmissionPointFeature:function(e){this.setFeatureStyle(e,"selectedStyle")}})</script>
</dom-module>
