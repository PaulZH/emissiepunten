<!-- elements -->
<link rel="import" href="../../bower_components/polymer/polymer.html"/>
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html"/>
<link rel="import" href="../ev-responsive/ev-responsive.html"/>
<link rel="import" href="../ev-data-table/ev-data-table.html"/>
<link rel="import" href="../ev-sparql-query/ev-sparql-query.html"/>
<link rel="import" href="../ev-substance-selector/ev-substance-selector.html"/>
<link rel="import" href="../ev-emission-vega-chart/ev-emission-vega-chart.html"/>
<!-- styles -->
<link rel="import" href="../app/app-styles.html"/>
<!-- behaviors -->
<link rel="import" href="../app/behaviors/app-term-labels.html"/>

<dom-module id="ev-emission-point">

    <template>

        <style include="app-styles">
            :host {
                display: block;
            }

            /*noinspection CssUnusedSymbol*/
            [w7a] .columns {
                @apply(--layout-horizontal);
            }

            .columns > * {
                padding: 16px;
                box-sizing: border-box;
                overflow: hidden;
                min-height: 350px;
            }

            [w7a] .columns > * {
                flex: 0 0 50%;
                @apply(--layout-self-stretch);
                min-width: 0;/* needed by firefox to keep flex-basis 50% */
            }

            .columns > :first-child {
                border-bottom: 1px solid var(--ev-app-grey-6);
            }

            [w7a] .columns > :first-child {
                border-right: 1px solid var(--ev-app-grey-6);
                border-bottom: none;
            }
        </style>

        <ev-responsive>
            <div class="columns">
                <div id="data">
                    <template is="dom-if" if="{{epData}}">
                        <ev-data-table title="Emission Point Data" data="{{epData}}" term-labels="{{termLabels}}"></ev-data-table>
                    </template>
                </div>
                <div id="charts">
                    <div>
                        <template is="dom-if" if="{{emissions}}">
                            <div class="controls">
                                <ev-substance-selector substances="{{emissions.substances}}" substance="{{selectedSubstance}}"></ev-substance-selector>
                                <span class="heading">Emissions</span>
                            </div>
                            <div class="chart">
                                <ev-emission-vega-chart data="{{emissions}}" substance="{{selectedSubstance}}"></ev-emission-vega-chart>
                            </div>
                        </template>

                        <template is="dom-if" if="{{!emissions}}">
                            <div class="no-emissions">
                                No emission data available
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </ev-responsive>

        <ev-sparql-query id="data" api="imjv" results="{{epData}}">
            SELECT ?p ?o WHERE {
                <{{emissionPoint.uri}}> ?p ?o .
            }
            ORDER BY ?p
            LIMIT 100
        </ev-sparql-query>

        <ev-sparql-query id="emissions" api="imjv" results="{{emissionData}}">
            SELECT ?year ?substance ?amount ?unit WHERE {
                ?obs a cube:Observation ;
                     milieu:referentiegebied <{{emissionPoint.uri}}> ;
                     milieu:tijdsperiode ?year ;
                     milieu:substantie ?substance ;
                     milieu:hoeveelheid ?amount ;
                     sdmx:unitMeasure ?unit .
            }
            ORDER BY ?year ?substance
            LIMIT 100
        </ev-sparql-query>

    </template>

    <script>

        Polymer({

            is: 'ev-emission-point',

            behaviors: [
                appTermLabels
            ],

            properties: {
                emissionPoint: {
                    type: Object,
                    observer: "onEmissionPointChanged"
                },
                /** emission data */
                emissionData: {
                    type: Object,
                    value: null,
                    observer: 'onEmissionData'
                }
            },

            onEmissionPointChanged: function (emissionPoint) {
                if (emissionPoint) {
                    this.$.data.execute();
                    //noinspection JSUnresolvedVariable
                    this.$.emissions.execute();
                }
            },

            onEmissionData: function (emissionData) {
                var self = this;
                this.set('emissions', null);
                var bindings = emissionData
                        ? emissionData.bindings
                        : [];
                var emissions = { substances: []};
                bindings.forEach(function (binding) {
                    //noinspection JSUnresolvedVariable
                    var year = binding.year.value;
                    var substance = self.getTermLabel(binding.substance.value);
                    var amount = parseFloat(binding.amount.value);
                    var unit = self.getTermLabel(binding.unit.value);
                    if (!emissions[substance]) {
                        emissions[substance] = {};
                        emissions.substances.push(substance);
                    }
                    if (!emissions[substance][year]) {
                        emissions[substance][year] = { unit: unit, amount: 0};
                    }
                    emissions[substance][year].amount += amount;
                });
                if (emissions.substances.length) {
                    this.set('emissions', emissions);
                }
            }
        });

    </script>

</dom-module>
