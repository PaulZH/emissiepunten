<!-- elements -->
<link rel="import" href="../../../bower_components/polymer/polymer.html"/>
<link rel="import" href="../../ev-sparql-query/ev-sparql-query.html?##appVersion##"/>

<dom-module id="sites-query">

    <template>
            SELECT DISTINCT ?site ?siteLabel (COUNT(DISTINCT ?ep) AS ?epCount) WHERE {
                SERVICE geo:search {
                    ?ep geo:search "inCircle";
                    geo:searchDatatype geoliteral:lat-lon ;
                    geo:predicate wgs84:lat_long;
                    geo:spatialCircleCenter "{{location.lat}}#{{location.lon}}";
                    geo:spatialCircleRadius "{{getQueryRadius(location.radius)}}" .
                }
        <ev-sparql-query query-id="sites" id="query" api="imjv" notify-map="true" results="{{response}}">
                ?ep a milieu:Emissiepunt ;
                    milieu:exploitatie ?site .
                ?site rdfs:label ?siteLabel .
            }
            GROUP BY ?site ?siteLabel
        </ev-sparql-query>
    </template>

    <script>
        //noinspection JSUnusedGlobalSymbols
        Polymer({

            is: 'sites-query',

            properties: {
                /** response */
                response: {
                    type: Object,
                    notify: true
                },
                /** selected map location */
                location: {
                    type: Object // lat, lon, radius, point
                }
            },

            /**
             * Returns a slightly increased location radius
             *
             * The query radius includes sites whose EPs are *just* outside of the location radius
             */
            getQueryRadius: function (radius) {
                if (radius <= 5) {
                    return radius * 1.5;
                }
                return radius * 1.1;
            },

            execute: function () {
                this.$.query.execute();
            }
        });
    </script>

</dom-module>
