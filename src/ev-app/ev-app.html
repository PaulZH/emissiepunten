<!-- elements -->
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html"/>
<link rel="import" href="../ev-responsive/ev-responsive.html"/>
<link rel="import" href="../ev-site-list/ev-site-list.html"/>
<link rel="import" href="../ev-map/ev-map.html"/>
<!-- styles -->
<link rel="import" href="../app/app-styles.html"/>
<!-- behaviors -->
<link rel="import" href="../app/behaviors/app-lazyloading.html"/>

<dom-module id="ev-app">
    <template>

        <style include="app-styles">
            :host {
                display: block;
            }

            /* list and map */

            #list-and-map {
                @apply(--layout-horizontal);
            }

            ev-site-list {
                display: none;
            }

            [w8a] ev-site-list {
                display: block;
                @apply(--layout-flex-3);
                margin-right: 16px;
            }

            ev-map {
                @apply(--layout-flex-9);
                max-width: 100%;
            }

            /* data-pane */

            ev-data-pane {
                margin-top: 16px;
            }

        </style>

        <ev-responsive>
            <section id="list-and-map">
                <ev-site-list geolocate="{{geolocate}}" location="{{location}}" sites="{{sites}}"
                              selected-site="{{selectedSite}}"></ev-site-list>
                <ev-map location="{{location}}" geolocate="{{geolocate}}" sites="{{sites}}"
                        selected-site="{{selectedSite}}" selected-emission-point="{{selectedEmissionPoint}}"></ev-map>
            </section>

            <template is="dom-if" if="[[deferredElementsLoaded]]">
                <ev-data-pane site="{{selectedSite}}" emission-point="{{selectedEmissionPoint}}"></ev-data-pane>
                <app-location route="{{route}}"></app-location>
                <app-route route="{{route}}" pattern=":page" data="{{routeData}}" tail="{{tailData}}"></app-route>
            </template>
        </ev-responsive>

    </template>

    <script>
        //noinspection JSUnusedGlobalSymbols
        Polymer({

            is: 'ev-app',

            behaviors: [
                appLazyloading
            ],

            properties: {
                /** The app's current view (a path) */
                view: {
                    type: String,
                    reflectToAttribute: true,
                    value: app.activeView,
                    observer: 'onViewChanged'
                },
                /** Request parameters */
                query: {
                    type: Object
                },
                /** Currently selected map location */
                location: {
                    type: Object, // lat, lon, radius
                    value: {lat: null, lon: null, radius: 10, point: null}
                },
                /** Currently selected site */
                selectedSite: {
                    type: Object,
                    value: null
                },
                /** currently selected emission point */
                selectedEmissionPoint: {
                    type: Object,
                    value: null
                }
            },

            observers: [
                'onRouteChanged(routeData)',
                'onRouteChanged(tailData)',
                'onDataPaneActive(selectedSite,selectedEmissionPoint)',
                'onSiteSelected(selectedSite)'
            ],

            attached: function () {
                // render deferred elements
                this.async(this.renderDeferredElements, 100);
            },

            /**
             * Defers expensive and/or less important elements
             */
            renderDeferredElements: function () {
                var self = this;
                this.lazyload([
                    "../ev-data-pane/ev-data-pane.html",
                    "../../bower_components/app-route/app-location.html",
                    "../../bower_components/app-route/app-route.html"
                ]).then(function () {
                    self.set('deferredElementsLoaded', true);
                });
            },

            onDataPaneActive: function (selectedSite, selectedEmissionPoint) {
                if (selectedSite || selectedEmissionPoint) {
                    this.expandCanvas();
                    this.scrollIn();
                }
            },

            /**
             * Expands the layout so that scroll bars don't get removed when the pane is temporarily inactive
             */
            expandCanvas: function () {
                this.style.minHeight = this.offsetHeight + 'px';
            },

            /**
             * Scroll the viewport to the top of the app element so that the data pane becomes visible
             *
             * @param loops Number of animation ticks
             */
            scrollIn: function (loops) {
                var self = this;
                loops = loops || 0;
                var targetTop = this.offsetTop;
                var currentTop = document.body.scrollTop || document.documentElement.scrollTop;
                if (targetTop > currentTop && loops < 20) {
                    var nextTop = currentTop + (targetTop - currentTop) / (20 - loops);
                    document.body.scrollTop = nextTop;
                    document.documentElement.scrollTop = nextTop;
                    this.async(function () {
                        self.scrollIn(loops + 1);
                    }, 10);
                }
            },

            /**
             * Sets the element's `view` parameter when the route changes (not used yet)
             */
            onRouteChanged: function () {
                //noinspection JSUnresolvedVariable
                if (!this.tailData || this.tailData.prefix === null) {
                    return; // route not parsed yet
                }
                //noinspection JSUnresolvedVariable
                this.view = (this.tailData.prefix || '') + (this.tailData.path || '');
                //noinspection JSUnusedGlobalSymbols,JSUnresolvedVariable
                this.query = this.tailData.__queryParams;
            },

            /**
             * Handles a view-change
             */
            onViewChanged: function () {
                if (this.view === app.activeView) {
                    return; // false positive
                }
                // set active view
                app.activeView = this.view;
            },

            onSiteSelected: function(site) {
                if (site) {
                    this.$$('app-location').set('__query', 'site=' + site.uri);
                }
            }
        });
    </script>

</dom-module>
