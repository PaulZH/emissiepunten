
<!--suppress JSUnresolvedVariable, JSUnusedGlobalSymbols -->
<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="ev-app">
    <template>

        <style>
            :host {
                display: block;
            }

            /* list and map */

            #list-and-map {
                @apply(--layout-horizontal);
            }

            ev-result-list {
                display: none;
            }

            [w8a] ev-result-list {
                display: block;
                @apply(--layout-flex-3);
                margin-right: 16px;
            }

            ev-map {
                @apply(--layout-flex-9);
                max-width: 100%;
            }

            /* emission point */

            #emission-point {
                margin-top: 16px;
            }

        </style>

        <app-location route="{{route}}"></app-location>
        <app-route route="{{route}}" pattern=":page" data="{{routeData}}" tail="{{tailData}}"></app-route>

        <ev-responsive>
            <section id="list-and-map">
                <ev-result-list geolocate={{geolocate}} location={{location}} points="{{emissionPoints}}" point="{{selectedEmissionPoint}}"></ev-result-list>
                <ev-map location={{location}} geolocate={{geolocate}} emission-points="{{emissionPoints}}" selected-emission-point="{{selectedEmissionPoint}}"></ev-map>
            </section>

            <template is="dom-if" if="{{selectedEmissionPoint}}">
                <section id="emission-point">
                    <ev-emission-point point="{{selectedEmissionPoint}}"></ev-emission-point>
                </section>
            </template>
        </ev-responsive>

    </template>

    <script>
        Polymer({

            is: 'ev-app',

            properties: {
                base: {
                    type: String,
                    value: app.base
                },
                /**
                 * The app's current view (a path)
                 */
                view: {
                    type: String,
                    reflectToAttribute: true,
                    value: app.activeView,
                    observer: 'onViewChanged'
                },
                /**
                 * Request parameters
                 */
                query: {
                    type: Object
                },
                /**
                 * Matching emission points
                 */
                emissionPoints: {
                    type: Array,
                    notify: true,
                    value: []
                }
            },

            observers: [
                'onRouteChanged(routeData)',
                'onRouteChanged(tailData)',
                'onLocationSelected(location.point,selectedEmissionPoint)'
            ],

            ready: function () {
                // lazy-load elements
                this.importHref(this.resolveUrl("../../bower_components/iron-flex-layout/iron-flex-layout.html"), null, null, true);
                this.importHref(this.resolveUrl("../../bower_components/app-route/app-location.html"), null, null, true);
                this.importHref(this.resolveUrl("../../bower_components/app-route/app-route.html"), null, null, true);
                this.importHref(this.resolveUrl("../ev-responsive/ev-responsive.html"), null, null, true);
                this.importHref(this.resolveUrl("../ev-result-list/ev-result-list.html"), null, null, true);
                this.importHref(this.resolveUrl("../ev-map/ev-map.html"), null, null, true);
                this.importHref(this.resolveUrl("../ev-emission-point/ev-emission-point.html"), null, null, true);
            },

            /**
             * Sets the element's `view` parameter when the route changes
             */
            onRouteChanged: function () {
                if (!this.tailData || this.tailData.prefix === null) {
                    return; // route not parsed yet
                }
                this.view = (this.tailData.prefix || '') + (this.tailData.path || '');
                this.query = this.tailData.__queryParams;
            },

            /**
             * Handles a view-change
             */
            onViewChanged: function () {
                if (this.view === app.activeView) {
                    return; // false positive
                }
                // set active view
                app.activeView = this.view;
            },

            onLocationSelected: function () {
                // scroll down to top of map  so that emission point moves above the fold
                this.scrollIn();
            },

            scrollIn: function(loops) {
                var self = this;
                loops = loops || 0;
                var targetTop = this.offsetTop;
                var currentTop = document.body.scrollTop || document.documentElement.scrollTop;
                if (targetTop > currentTop && loops < 20) {
                    var nextTop = currentTop + (targetTop - currentTop) / (20 - loops);
                    document.body.scrollTop = nextTop;
                    document.documentElement.scrollTop = nextTop;
                    this.async(function () {
                        self.scrollIn(loops + 1);
                    }, 10);
                }
            }

        });
    </script>

</dom-module>
