<!-- elements -->
<link rel="import" href="../../bower_components/polymer/polymer.html"/>
<link rel="import" href="../openlayers/openlayers-assets.html"/>
<link rel="import" href="../ev-card/ev-card.html"/>
<!-- styles -->
<link rel="import" href="../app/app-styles.html"/>

<dom-module id="ev-map-emission-points-overlay">

    <style include="app-styles">
        :host {
            display: block;
            position: absolute;
            left: 8px;
            top: 8px;
            bottom: 8px;
            width: 200px;
            opacity: 0.95;
        }

        #overlay {
        }

        #overlay > ev-card {
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.15);
            --ev-card-title: {
                height: 32px;
                line-height: 32px;
                border-bottom: 1px solid #fff;
                overflow: hidden;
                white-space: nowrap;
                text-overflow: ellipsis;
                box-sizing: border-box;
            };
            --ev-card-content: {
                max-height: 362px;
            };
        }

        /*noinspection CssUnusedSymbol*/
        #overlay > ev-card > .title {/* needed for polyfilled firefox */
            height: 32px;
            line-height: 32px;
            border-bottom: 1px solid #fff;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            box-sizing: border-box;
        }

        /*noinspection CssUnusedSymbol*/
        #overlay > ev-card > .content {/* needed for polyfilled firefox */
            max-height: 362px;
        }

        #overlay .ep {
            border-bottom: 1px solid;
            padding: 8px 16px;
            border-bottom: 1px solid var(--ev-app-grey-6);
            color: var(--ev-app-green-1);
            cursor: pointer;
            font-size: 0.95em;
        }

        #overlay .ep:hover {
            background-color: var(--ev-app-green-3);
        }

        /*noinspection CssUnusedSymbol*/
        #overlay .ep.selected {
            background-color: var(--ev-app-green-2);
            color: #fff;
            border-bottom: none;
        }
    </style>

    <template>
        <div id="overlay" hidden$="{{!site.eps}}">
            <ev-card title="Emission Points: {{site.eps.length}}">
                <template is="dom-repeat" items="{{site.eps}}">
                    <div class="ep" on-tap="onEmissionPointClicked" ep="{{item}}" data-uri$="{{item.uri}}">
                        [[item.shortLabel]]
                    </div>
                </template>
            </ev-card>
        </div>
    </template>

    <script>
        //noinspection JSUnusedGlobalSymbols
        Polymer({

            is: 'ev-map-emission-points-overlay',

            properties: {
                /** openlayers map */
                olMap: Object,
                /** selected site */
                site: {
                    type: Object,
                    observer: 'onSiteChanged'
                },
                /* selected emission point */
                emissionPoint: {
                    type: Object,
                    notify: true,
                    observer: 'onEmissionPointChanged'
                }
            },

            observers: [
                'onEpsChanged(site.eps)'
            ],

            onSiteChanged: function (site) {
                var self = this;
                clearTimeout(this.zoomOutTO);
                if (!site) {
                    this.set('eps', null);
                    this.zoomOutTO = setTimeout(function () {
                        self.zoomOut();
                    }, 100);
                    return;
                }
                // update template vars
                this.set('site', site);
                // deselect any emission points
                this.resetSelection();
                // pan/zoom to site
                this.debounce('transitionToSite', this.transitionToSite, 100);
            },

            onEpsChanged: function(eps) {
                if (!this.site || !eps) {
                    return;
                }
                this.resetSelection();
            },

            zoomOut: function () {
                if (!this.location.point) {
                    return;
                }
                var view = this.olMap.getView();
                // pan
                //noinspection JSCheckFunctionSignatures
                var pan = ol.animation.pan({
                    source: view.getCenter(),
                    duration: 500
                });
                // zoom
                var currentResolution = view.getResolution();
                var targetResolution = this.location.radius * 10;
                //noinspection JSCheckFunctionSignatures
                var zoom = ol.animation.zoom({
                    resolution: currentResolution,
                    duration: 500
                });
                // run animation
                this.olMap.beforeRender(pan, zoom);
                view.setCenter(this.location.point);
                view.setResolution(targetResolution);
            },

            transitionToSite: function () {
                if (!this.site) {
                    return;
                }
                var view = this.olMap.getView();
                // pan
                //noinspection JSCheckFunctionSignatures
                var pan = ol.animation.pan({
                    source: view.getCenter(),
                    duration: 500
                });
                // run animation
                this.olMap.beforeRender(pan);
                //noinspection JSCheckFunctionSignatures
                view.setCenter([this.site.x, this.site.y]);
            },

            onEmissionPointChanged: function (ep) {
                // deselect any emission points
                this.resetSelection();
                if (ep) {
                    this.selectEmissionPoint(ep);
                    this.async(this.transitionToEmissionPoint, 1);
                }
            },

            transitionToEmissionPoint: function () {
                var view = this.olMap.getView();
                // pan
                //noinspection JSCheckFunctionSignatures
                var pan = ol.animation.pan({
                    source: view.getCenter(),
                    duration: 500
                });
                // zoom
                var currentResolution = view.getResolution();
                var targetResolution = 12;
                //noinspection JSCheckFunctionSignatures
                var zoom = ol.animation.zoom({
                    resolution: currentResolution,
                    duration: 500
                });
                // run animation
                if (currentResolution > targetResolution) {//only zoom in, never out
                    this.olMap.beforeRender(pan, zoom);
                    //noinspection JSCheckFunctionSignatures
                    view.setCenter([this.site.x, this.site.y]);
                    view.setResolution(targetResolution);
                }
            },

            onEmissionPointClicked: function (event) {
                var $ep = Polymer.dom(event).rootTarget;
                var ep = $ep.ep;
                if (this.emissionPoint && this.emissionPoint.uri === ep.uri) {// toggle current
                    return this.set('emissionPoint', null);
                } else {// select clicked
                    this.set('emissionPoint', ep);
                }
            },

            /**
             * Removes all `selected` classes from nodes in the given container
             *
             */
            resetSelection: function () {
                var items = this.$.overlay.querySelectorAll('.selected');
                for (var i = 0; i < items.length; i++) {
                    items[i].classList.remove('selected');
                }
            },

            selectEmissionPoint: function (ep) {
                var items = this.$.overlay.querySelectorAll('.ep');
                for (var i = 0; i < items.length; i++) {
                    if (items[i].ep.uri === ep.uri) {
                        items[i].classList.add('selected');
                    } else {
                        items[i].classList.remove('selected');
                    }
                }
            }
        });
    </script>

</dom-module>
