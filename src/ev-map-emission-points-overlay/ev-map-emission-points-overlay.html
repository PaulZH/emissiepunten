<!-- elements -->
<link rel="import" href="../../bower_components/polymer/polymer.html"/>
<link rel="import" href="../openlayers/openlayers-assets.html"/>
<link rel="import" href="../ev-card/ev-card.html"/>

<dom-module id="ev-map-emission-points-overlay">

    <template>
        <div id="overlay">
            <ev-card title="{{site.label}}">
                <template is="dom-repeat" items="{{eps}}" restamp="true">
                    <div class="ep" on-tap="onEmissionPointClicked" ep="[[item]]">[[item.shortLabel]]</div>
                </template>
            </ev-card>
        </div>
    </template>

    <script>
        //noinspection JSUnusedGlobalSymbols
        Polymer({

            is: 'ev-map-emission-points-overlay',

            properties: {
                /** openlayers map */
                olMap: Object,
                /** selected site feature */
                siteFeature: {
                    type: Object,
                    observer: 'onSiteFeatureChanged'
                },
                /* emission points of the selected site */
                eps: {
                    type: Array
                },
                /* selected emission point */
                emissionPoint: {
                    type: Object,
                    notify: true
                }
            },

            ready: function () {
                this.renderOverlay();
            },

            renderOverlay: function () {
                this.overlay = new ol.Overlay({
                    element: this.$.overlay,
                    positioning: 'top-right',
                    autoPan: true,
                    offset: [-40, -42]
                });
                this.olMap.addOverlay(this.overlay);
            },

            onSiteFeatureChanged: function (siteFeature) {
                var element = this.overlay.getElement();
                if (!siteFeature) {
                    element.style.display = 'none';
                    this.set('emissionPoint', null);
                    return;
                }
                // update template vars
                var site = siteFeature.get('site');
                this.set('site', site);
                this.set('eps', site.eps);
                // position element
                var wgs84Point = [parseFloat(site.lon), parseFloat(site.lat)];
                //noinspection JSCheckFunctionSignatures
                var lambertPoint = ol.proj.transform(wgs84Point, 'EPSG:4326', 'EPSG:31370');
                element.style.display = 'block';
                this.async(function () {
                    this.overlay.setPosition(lambertPoint);
                }, 1);
                // deselect any emission points
                this.resetSelection(this.$.overlay);
            },

            onEmissionPointClicked: function (event) {
                var $ep = Polymer.dom(event).rootTarget;
                var ep = $ep.ep;
                ep.element = $ep;
                // toggle current
                if (this.emissionPoint && this.emissionPoint.uri === ep.uri) {
                    $ep.classList.remove('selected');
                    this.set('emissionPoint', null);
                    return;
                }
                // deselect any emission points
                this.resetSelection(this.$.overlay);
                // select new
                $ep.classList.add('selected');
                this.set('emissionPoint', ep);
            },

            /**
             * Removes all `selected` classes from nodes in the given container
             *
             * @param $list
             */
            resetSelection: function ($list) {
                var items = $list.querySelectorAll('.selected');
                for (var i = 0; i < items.length; i++) {
                    items[i].classList.remove('selected');
                }
            }
        });
    </script>

</dom-module>
