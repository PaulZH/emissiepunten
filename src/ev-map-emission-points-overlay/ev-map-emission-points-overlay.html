<!-- elements -->
<link rel="import" href="../../bower_components/polymer/polymer.html"/>
<link rel="import" href="../openlayers/openlayers-assets.html"/>
<link rel="import" href="../ev-card/ev-card.html"/>

<dom-module id="ev-map-emission-points-overlay">

    <template>
        <div id="overlay">
            <ev-card title="{{site.label}}">
                <template is="dom-repeat" items="{{eps}}">
                    <div class="ep" on-tap="onEmissionPointClicked" ep="{{item}}" data-uri$="{{item.uri}}">
                        [[item.shortLabel]]
                    </div>
                </template>
            </ev-card>
        </div>
    </template>

    <script>
        //noinspection JSUnusedGlobalSymbols
        Polymer({

            is: 'ev-map-emission-points-overlay',

            properties: {
                /** openlayers map */
                olMap: Object,
                /** selected site */
                site: {
                    type: Object,
                    observer: 'onSiteChanged'
                },
                /* emission points of the selected site */
                eps: {
                    type: Array
                },
                /* selected emission point */
                emissionPoint: {
                    type: Object,
                    notify: true,
                    observer: 'onEmissionPointChanged'
                }
            },

            ready: function () {
                this.renderOverlay();
            },

            renderOverlay: function () {
                this.overlay = new ol.Overlay({
                    element: this.$.overlay,
                    positioning: 'top-right',
                    autoPan: true,
                    offset: [-40, -42],
                    insertFirst: false // show above controls
                });
                this.olMap.addOverlay(this.overlay);
            },

            onSiteChanged: function (site) {
                var self = this;
                if (!this.overlay) {
                    return;
                }
                clearTimeout(this.zoomOutTO);
                if (!site) {
                    this.overlay.getElement().style.display = 'none';
                    this.set('eps', null);
                    this.zoomOutTO = setTimeout(function () {
                        self.zoomOut();
                    }, 100);
                    return;
                }
                // update template vars
                this.set('site', site);
                this.set('eps', site.eps);
                // deselect any emission points
                this.resetSelection();
                this.positionOverlay();
            },

            zoomOut: function () {
                var view = this.olMap.getView();
                // pan
                //noinspection JSCheckFunctionSignatures
                var pan = ol.animation.pan({
                    source: view.getCenter(),
                    duration: 500
                });
                // zoom
                var currentResolution = view.getResolution();
                var targetResolution = this.location.radius * 10;
                //noinspection JSCheckFunctionSignatures
                var zoom = ol.animation.zoom({
                    resolution: currentResolution,
                    duration: 500
                });
                // run animation
                this.olMap.beforeRender(pan, zoom);
                view.setCenter(this.location.point);
                view.setResolution(targetResolution);
            },

            onEmissionPointChanged: function (ep) {
                // deselect any emission points
                this.resetSelection();
                if (ep) {
                    this.selectEmissionPoint(ep);
                    this.async(function () {
                        this.transitionToEmissionPoint();
                    }, 1);
                }
            },

            positionOverlay: function (delay) {
                this.overlay.getElement().style.display = 'block';
                this.async(function () {
                    var lambertPoint = [this.site.x, this.site.y];
                    //noinspection JSCheckFunctionSignatures
                    this.overlay.setPosition(lambertPoint);
                }, delay || 1);
            },

            transitionToEmissionPoint: function () {
                var view = this.olMap.getView();
                // pan
                //noinspection JSCheckFunctionSignatures
                var pan = ol.animation.pan({
                    source: view.getCenter(),
                    duration: 500
                });
                // zoom
                var currentResolution = view.getResolution();
                var targetResolution = 16;
                //noinspection JSCheckFunctionSignatures
                var zoom = ol.animation.zoom({
                    resolution: currentResolution,
                    duration: 500
                });
                // run animation
                if (currentResolution > targetResolution) {//only zoom in, never out
                    this.olMap.beforeRender(pan, zoom);
                    //noinspection JSCheckFunctionSignatures
                    view.setCenter([this.site.x, this.site.y]);
                    view.setResolution(targetResolution);
                }
                // position overlay
                this.positionOverlay(1000);
            },

            onEmissionPointClicked: function (event) {
                var $ep = Polymer.dom(event).rootTarget;
                var ep = $ep.ep;
                if (this.emissionPoint && this.emissionPoint.uri === ep.uri) {// toggle current
                    return this.set('emissionPoint', null);
                } else {// select clicked
                    this.set('emissionPoint', ep);
                }
            },

            /**
             * Removes all `selected` classes from nodes in the given container
             *
             * @param $list
             */
            resetSelection: function () {
                var items = this.$.overlay.querySelectorAll('.selected');
                for (var i = 0; i < items.length; i++) {
                    items[i].classList.remove('selected');
                }
            },

            selectEmissionPoint: function (ep) {
                var items = this.$.overlay.querySelectorAll('.ep');
                for (var i = 0; i < items.length; i++) {
                    if (items[i].ep.uri === ep.uri) {
                        items[i].classList.add('selected');
                    } else {
                        items[i].classList.remove('selected');
                    }
                }
            }
        });
    </script>

</dom-module>
