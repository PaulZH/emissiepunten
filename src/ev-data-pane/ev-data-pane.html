<!-- elements -->
<link rel="import" href="../../bower_components/polymer/polymer.html"/>
<!-- behaviors -->
<link rel="import" href="../app/behaviors/app-lazyloading.html"/>

<dom-module id="ev-data-pane">

    <template>

        <style>

            :host {
                display: block;
                --ev-card-content: {
                    min-height: 350px;
                };
            }

            ev-card {
                display: none;
            }

            /*noinspection CssUnusedSymbol*/
            ev-card.active {
                display: block;
            }

        </style>

        <template is="dom-if" if="[[deferredElementsLoaded]]">
            <ev-card title="[[getCardTitle(site,emissionPoint)]]" class$="[[getCardClass(site)]]">
                <template is="dom-if" if="[[showSitePane(site,emissionPoint)]]" restamp="true">
                    <ev-site site="[[site]]" term-labels="{{termLabels}}"></ev-site>
                </template>
                <template is="dom-if" if="[[showEmissionPointPane(emissionPoint)]]" restamp="true">
                    <ev-emission-point emission-point="[[emissionPoint]]" term-labels="{{termLabels}}"></ev-emission-point>
                </template>
            </ev-card>

            <ev-sparql-query id="labels" api="imjv" results="{{labelResults}}">
                SELECT DISTINCT ?term ?label WHERE {
                    {
                        ?ep a milieu:Emissiepunt ;
                            ?term ?o .
                    }
                    UNION {
                        ?obs milieu:substantie ?term .
                    }
                    UNION {
                        ?obs sdmx:unitMeasure ?term .
                    }
                    UNION {
                        ?ep dct:type ?term .
                    }
                    ?term ?labelProp ?label .
                    FILTER (?labelProp = rdfs:label || ?labelProp = skos:prefLabel)
                }
                LIMIT 500
            </ev-sparql-query>
        </template>

    </template>

    <script>
        //noinspection JSUnusedGlobalSymbols
        Polymer({

            is: 'ev-data-pane',

            behaviors: [
                appLazyloading
            ],

            properties: {
                /** Selected site */
                site: {
                    type: Object,
                    notify: true,
                    value: null
                },
                /** Selected EP */
                emissionPoint: {
                    type: Object,
                    notify: true
                }
            },

            observers: [
                'onLabelsLoaded(labelResults)'
            ],

            attached: function () {
                // render deferred elements
                this.async(this.renderDeferredElements, 1000);
            },

            /**
             * Renders elements that are not immediately needed
             */
            renderDeferredElements: function () {
                var self = this;
                this.lazyload([
                    "../ev-card/ev-card.html",
                    "../ev-site/ev-site.html",
                    "../ev-emission-point/ev-emission-point.html",
                    "../ev-sparql-query/ev-sparql-query.html"
                ]).then(function () {
                    self.set('deferredElementsLoaded', true);
                    // fetch term labels
                    self.async(function () {
                        self.$$('#labels').execute();
                    }, 1)
                });
            },

            getCardTitle: function (site, emissionPoint) {
                if (site && emissionPoint) {
                    return emissionPoint.label;
                }
                else if (site) {
                    return site.label
                } else {
                    return '';
                }
            },

            getCardClass: function (site) {
                return (site)
                        ? 'active'
                        : 'hidden';
            },

            showSitePane: function (site, emissionPoint) {
                return !!(site && !emissionPoint);
            },

            showEmissionPointPane: function (emissionPoint) {
                return !!emissionPoint;
            },

            onLabelsLoaded: function (labelResults) {
                var termLabels = {};
                labelResults.bindings.forEach(function (binding) {
                    //noinspection JSUnresolvedVariable
                    var term = binding.term.value;
                    termLabels[term] = binding.label.value;
                });
                this.set('termLabels', termLabels);
            }
        });
    </script>

</dom-module>
