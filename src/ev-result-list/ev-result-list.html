
<link rel="import" href="../../bower_components/polymer/polymer.html"/>
<link rel="import" href="../../bower_components/paper-button/paper-button.html"/>
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html"/>
<link rel="import" href="../../bower_components/iron-icons/maps-icons.html"/>
<link rel="import" href="../../bower_components/iron-list/iron-list.html"/>
<link rel="import" href="../ev-card/ev-card.html"/>
<link rel="import" href="../app/app-styles.html"/>
<link rel="import" href="../app/app-fonts.html"/>

<dom-module id="ev-result-list">

    <template>

        <style include="app-styles app-fonts">

            :host {
                --ev-card-content: {
                    height: 410px;
                };
                --ev-card-title: {
                    border-bottom: 1px solid #fff;
                }
            }

            p {
                padding: 20px 20px;
                text-align: center;
                line-height: 1.5;
            }

            p.intro {
                margin-top: 20px;
            }

            p.get-started .heading {
                display: block;
                font-weight: 500;
                margin-bottom: 16px;
            }

            span.sub-info {
                display: block;
                margin-top: 8px;
                color: var(--ev-app-grey-4);
            }

            paper-button {
                background-color: var(--ev-app-green-2);
                color: #fff;
                font-size: 15px;
                font-weight: 500;
                font-family: "Flanders Sans", sans-serif;
                padding-right: 20px;
            }

            iron-icon {
                margin-right: 12px;
                --iron-icon-width: 20px;
                --iron-icon-height: 20px;
            }

            /* list */

            iron-list {
                height: 100%;
            }

            .list-item {
                padding: 16px 16px 16px 60px;
                min-height: 60px;
                background: transparent url("img/emission-icon.png") 16px 16px no-repeat;
                border-bottom: 1px solid var(--ev-app-grey-6);
                color: var(--ev-app-green-1);
            }

            .list-item:last-child {
                border-bottom: none;
            }

            .list-item.selected {
                background-color: var(--ev-app-green-2);
                color: #fff;
            }

        </style>

        <ev-card title="{{title}}">

            <!-- no points -->
            <template is="dom-if" if="{{!points.length}}">
                <p class="intro">
                    Find emission points across Flanders. Explore locations, organisations and detailed pollution data.
                </p>
                <p class="get-started">
                    <span class="heading">Get started:</span>
                    <paper-button raised on-tap="onGeolocate">
                        <iron-icon icon="maps:my-location"></iron-icon>
                        Use my location
                    </paper-button>
                    <span class="sub-info">or just click on the map</span>
                </p>
            </template>

            <!-- points found -->
            <template is="dom-if" if="{{points.length}}">
                <iron-list items="[[points]]" selection-enabled selected-item="{{selectedItem}}">
                    <template>
                        <div class$="[[getItemClass(selected)]]" data-uri="[[item.ep.value]]">
                            [[item.label.value]]
                        </div>
                    </template>
                </iron-list>
            </template>

        </ev-card>

    </template>

    <script>

        Polymer({

            is: 'ev-result-list',

            properties: {
                title: {
                    type: String
                },
                location: {
                    type: Object,
                    notify: true
                },
                points: {
                    type: Array,
                    observer: "onPointsChanged"
                },
                point: {
                    type: Object,
                    observer: "onPointChanged",
                    notify: true
                },
                selectedItem: {
                    type: Object,
                    observer: "onSelectionChanged"
                },
                geolocate: {
                    type: Boolean,
                    notify: true
                }
            },

            attached: function () {
                this.updateTitle();
            },

            listeners: {
                //'tap': 'onTap'
            },

            updateTitle: function () {
                if (this.location && this.location.point) {
                    var hits = (this.points.length || 0);
                    this.title = (hits === 1)
                        ? '1 Emission Point found'
                        : hits + ' Emission Points found';
                } else {
                    this.title = 'Emission Points in Flanders';
                }
            },

            onPointsChanged: function () {
                this.updateTitle();
            },

            onPointChanged: function (point) {
                var $list = this.$$('iron-list');
                var selectedItem = $list ? $list.selectedItem : null;
                if (point && (!selectedItem || selectedItem.ep.value !== point.ep.value)) {
                    this.points.forEach(function (item) {
                        if (item.ep.value === point.ep.value) {
                            $list.selectItem(item);
                            $list.scrollToItem(item);
                        }
                    })
                } else if (!point && selectedItem) {
                    $list.clearSelection();
                }
            },

            getItemClass: function (selected) {
                return selected
                    ? 'list-item selected'
                    : 'list-item';
            },

            onItemLinkTapped: function (event) {
                event.preventDefault();
                var nEvent = Polymer.dom(event);
                var $a = nEvent.rootTarget || nEvent.event.explicitOriginalTarget || nEvent.event.originalTarget || nEvent.event.target;
                var $item = Polymer.dom($a).parentNode;
                var $list = this.$$('iron-list');
                var item = $list.modelForElement($item).item;
                $list.toggleSelectionForItem(item);
            },

            onSelectionChanged: function (selectedItem) {
                this.point = selectedItem;// propagates to map
            },

            onGeolocate: function () {
                this.set('geolocate', true);
            }

        });

    </script>

</dom-module>
