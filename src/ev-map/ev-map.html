
<link rel="import" href="../../bower_components/polymer/polymer.html"/>
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html"/>
<link rel="import" href="../ev-map/ev-map-core-behavior.html"/>
<link rel="import" href="../ev-map/ev-map-location-behavior.html"/>
<link rel="import" href="../ev-map/ev-map-emission-points-behavior.html"/>
<link rel="import" href="../ev-app/ev-app-rdf-behavior.html"/>

<link rel="import" href="../ev-radius/ev-radius.html"/>
<link rel="import" href="../openlayers/openlayers-styles.html"/>
<link rel="import" href="../app/app-styles.html"/>

<dom-module id="ev-map">

    <template>

        <style include="app-styles openlayers-styles">

            :host {
                --ev-card-content: {
                    height: 410px;
                }
            }

            #map {
                height: 100%;
                width: 100%;
                overflow: hidden;
                box-sizing: border-box;
            }

            #emission-points {
                background-color: #fff;
                box-shadow: 4px 4px 20px rgba(0,0,0,0.4);
                width: 240px;
                display: none;
            }

            #emission-points ev-card {
                --ev-card-content: {
                    max-height: 300px;
                };
                --ev-card-title: {
                    height: 32px;
                    line-height: 32px;
                    border-bottom: 1px solid #fff;
                };
            }

            #emission-points:after {
                left: 100%;
                top: 0;
                content: "";
                height: 0;
                width: 0;
                position: absolute;
                pointer-events: none;
                border: 16px solid transparent;
                border-left-color: var(--ev-app-green-2);
            }

            #emission-points .ep {
                border-bottom: 1px solid;
                padding: 8px 16px;
                border-bottom: 1px solid var(--ev-app-grey-6);
                color: var(--ev-app-green-1);
                cursor: pointer;
                font-size: 0.95em;
            }

            #emission-points .ep.selected {
                background-color: var(--ev-app-green-2);
                color: #fff;
            }

        </style>

        <ev-card title="{{title}}">
            <div id="map"></div>
            <ev-radius radius="{{location.radius}}"></ev-radius>
        </ev-card>

        <div id="emission-points">
            <ev-card title="[[selectedSite.label]]">
                <template is="dom-repeat" items="[[emissionPoints]]" restamp="true">
                    <div class="ep" on-tap="epOnEmissionPointClicked" ep="[[item]]">[[item.shortLabel]]</div>
                </template>
            </ev-card>
        </div>

        <iron-ajax id="emission-points-api"
                   url="{{sparqlApi}}"
                   headers='{"Accept": "application/json"}'
                   params='{{epApiParams}}'
                   handle-as="json"
                   on-response="epOnApiResponse"
                   on-error="epOnApiError"
                   debounce-duration="300">
            <pre>
            {{sparqlPrologue}}

            SELECT DISTINCT ?ep ?label ?lat ?lon ?site ?siteLabel WHERE {
                SERVICE geo:search {
                    ?ep geo:search "inCircle";
                    geo:searchDatatype geoliteral:lat-lon ;
                    geo:predicate wgs84:lat_long;
                    geo:spatialCircleCenter "{{location.lat}}#{{location.lon}}";
                    geo:spatialCircleRadius "{{location.radius}}" .
                }
                ?ep a milieu:Emissiepunt ;
                    rdfs:label ?label ;
                    wgs84_pos:lat ?lat ;
                    wgs84_pos:long ?lon ;
                    protontop:isOwnedBy ?site .
                ?site rdfs:label ?siteLabel .
            }
            ORDER BY DESC(?lat) DESC(?lon)
            LIMIT 1000
            </pre>
        </iron-ajax>

    </template>

    <script>

        Polymer({

            is: 'ev-map',

            behaviors: [
                evMapCore,
                evMapLocation,
                evAppRdf,
                evMapEmissionPoints
            ],

            properties: {
                /**
                 * map container element
                 */
                $map: {
                    type: Object
                },
                title: {
                    type: String,
                    computed: 'getTitle(location.*)'
                }
            },

            ready: function () {
                this.$map = this.$.map;
                this.importHref(this.resolveUrl("../ev-card/ev-card.html"));
                this.importHref(this.resolveUrl("../openlayers/openlayers-assets.html"), this.createMap, null, true);
            },

            getTitle: function () {
                if (this.location && this.location.lat) {
                    var t = 'Emission Sites within {radius}km of {lat},{lon}';
                    return t
                            .replace('{radius}', this.location.radius)
                            .replace('{lat}', this.location.lat.toFixed(5))
                            .replace('{lon}', this.location.lon.toFixed(5));
                } else {
                    return 'Select a location';
                }
            }
        });


    </script>

</dom-module>
