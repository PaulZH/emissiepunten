<!--suppress JSCheckFunctionSignatures, JSUnusedGlobalSymbols -->
<script>
    evMapEmissionPoints = {

        properties: {
            epApi: {
                type: Object
            },
            epApiParams: {
                type: Object
            },
            sitesLayer: {
                type: Object
            },
            selectedSiteFeature: {
                type: Object,
                notify: true,
                observer: 'epOnSiteFeatureSelected'
            },
            sites: {
                type: Array,
                notify: true,
                observer: 'epOnSitesChanged'
            },
            selectedSite: {
                type: Object,
                notify: true,
                observer: 'epOnSiteSelected'
            },
            emissionPointsListTitle: {
                type: String,
                notify: true
            },
            emissionPoints: {
                type: Array,
                notify: true,
                observer: 'epOnEmissionPointsChanged'
            },
            selectedEmissionPoint: {
                type: Object,
                notify: true,
                observer: 'epOnEmissionPointSelected'
            }
        },

        listeners: {
            'mapCreated': 'epOnMapCreated'
        },


        observers: [
            'epOnLocationChanged(location.*)'
        ],

        ready: function () {
            this.epApi = this.$['emission-points-api'];
        },

        epOnMapCreated: function (event, map) {
            // create vector layer
            this.createSitesLayer();
            // create ep overlay
            this.createEmissionPointsOverlay();
            // register click events
            var self = this;
            map.on('singleclick', function (event) {
                self.epOnMapClicked(event);
            });
        },

        createSitesLayer: function () {
            this.sitesLayer = new ol.layer.Vector({
                name: 'sites',
                source: new ol.source.Vector({}),
                style: new ol.style.Style({
                    image: new ol.style.Icon({
                        anchor: [0.5, 1],
                        size: [34, 36],
                        opacity: 0.9,
                        scale: 1,
                        src: 'src/ev-map/img/site-marker.png'
                    })
                })
            });
            this.olMap.addLayer(this.sitesLayer);
        },

        createEmissionPointsOverlay: function () {
            this.epOverlay = new ol.Overlay({
                element: this.$['emission-points'],
                positioning: 'top-right',
                autoPan: true,
                offset: [-40, -42]
            });
            this.olMap.addOverlay(this.epOverlay);
        },

        epOnLocationChanged: function () {
            this.debounce('epOnLocationChanged', this.retrieveEmissionPoints, 10);
        },

        retrieveEmissionPoints: function () {
            if (!this.location || !this.location.point) {
                return;
            }
            this.epApiParams = { query: this.epApi.textContent };
            this.epApi.generateRequest();
        },

        epOnApiResponse: function () {
            this.set('sites', this.getSites());
        },

        epOnApiError: function () {
            console.log('API Error', arguments)
        },

        getSites: function () {
            var rows = this.epApi.lastResponse.results.bindings;
            var sites = [];
            var sitesByUri = {};
            rows.forEach(function (row) {
                var siteUri = row.site.value;
                var siteLabel = row.siteLabel.value;
                if (!sitesByUri[siteUri]) {
                    sitesByUri[siteUri] = {
                        label: siteLabel,
                        uri: siteUri,
                        lat: row.lat.value,// use ep.lat instead of site.lambert_y
                        lon: row.lon.value,// use ep.lon instead of site.lambert_x
                        eps: []
                    };
                    sites.push(sitesByUri[siteUri]);
                }
                // add shortened EP label (site label prefix removed)
                row.shortLabel = row.label.value.replace(new RegExp('^' + siteLabel + '\\s*:\\s*'), '');
                sitesByUri[siteUri].eps.push(row);
            });
            return sites;
        },

        epOnSitesChanged: function (sites) {
            if (!this.olMap) {
                return;
            }
            var features = [];
            sites.forEach(function (site) {
                var wgs84Point = [parseFloat(site.lon), parseFloat(site.lat)];
                var lambertPoint = ol.proj.transform(wgs84Point, 'EPSG:4326', 'EPSG:31370');
                var feature = new ol.Feature({
                    name: 'site',
                    geometry: new ol.geom.Point(lambertPoint),
                    site: site
                });
                features.push(feature);
            });
            this.sitesLayer.getSource().clear();
            this.sitesLayer.getSource().addFeatures(features);
        },

        epOnEmissionPointsChanged: function (emissionPoints) {
            var plural = (emissionPoints.length === 1)
                    ? ''
                    : 's';
            this.set('emissionPointsListTitle', emissionPoints.length + ' Emission Point' + plural);
        },

        epOnMapClicked: function (event) {
            var features = this.getFeaturesAtPixel(event.pixel, 'site');
            if (!features.length) {
                return;
            }
            var feature = features[0];// pick top feature in case of stacked markers
            this.toggleFeature(feature);
        },

        toggleFeature: function (feature) {
            if (this.selectedSiteFeature === feature) {
                this.deselectFeature(feature);
            } else {
                this.selectFeature(feature);
            }
        },

        deselectFeature: function (feature) {
            feature.setStyle(new ol.style.Style({
                image: new ol.style.Icon({
                    anchor: [0.5, 1],
                    size: [34, 36],
                    opacity: 0.9,
                    scale: 1,
                    src: 'src/ev-map/img/site-marker.png'
                })
            }));
            if (this.selectedSiteFeature === feature) {
                this.set('selectedSiteFeature', null);
                this.set('selectedSite', null);
                this.set('selectedEmissionPoint', null);
            }
        },

        selectFeature: function (feature) {
            // cancel if already selected
            if (this.selectedSiteFeature === feature) {
                return;
            }
            // deselect existing
            if (this.selectedSiteFeature) {
                this.deselectFeature(this.selectedSiteFeature);
            }
            // select given
            feature.setStyle(new ol.style.Style({
                image: new ol.style.Icon({
                    anchor: [0.5, 1],
                    size: [38, 41],
                    opacity: 0.9,
                    scale: 1,
                    src: 'src/ev-map/img/site-marker-selected.png'
                })
            }));
            this.set('selectedSiteFeature', feature);
            this.set('selectedSite', feature.get('site'));
        },

        /**
         * processes changes in the result list
         *
         * @param emissionPoint
         */
        epOnSiteSelected: function (site) {
            if (site === null && this.selectedSiteFeature) {
                this.deselectFeature(this.selectedSiteFeature)
            } else if (site) {
                var features = this.sitesLayer.getSource().getFeatures();
                var self = this;
                features.forEach(function (feature) {
                    if (feature.get('site') === site) {
                        self.selectFeature(feature);
                    }
                });
            }
        },

        epOnSiteFeatureSelected: function (feature) {
            var element = this.epOverlay.getElement();
            if (!feature) {
                element.style.display = 'none';
                return;
            }
            element.style.display = 'block';
            var site = feature.get('site');
            var wgs84Point = [parseFloat(site.lon), parseFloat(site.lat)];
            var lambertPoint = ol.proj.transform(wgs84Point, 'EPSG:4326', 'EPSG:31370');
            this.set('emissionPoints', site.eps);
            this.async(function() {
                this.epOverlay.setPosition(lambertPoint);
                this.$['emission-points'].querySelectorAll('.selected').forEach(function(item) {
                    item.classList.remove('selected');
                });
            }, 1);
        },

        epOnEmissionPointClicked: function (event) {
            var $ep = Polymer.dom(event).rootTarget;
            var ep = $ep.ep;
            ep.element = $ep;
            // toggle current
            if (this.selectedEmissionPoint === ep) {
                $ep.classList.remove('selected');
                this.set('selectedEmissionPoint', null);
                return;
            }
            // deselect previous
            if (this.selectedEmissionPoint) {
                this.selectedEmissionPoint.element.classList.remove('selected');
            }
            // select new
            $ep.classList.add('selected');
            this.set('selectedEmissionPoint', ep);
        },

        epOnEmissionPointSelected: function (ep) {

        }

    }
</script>
