<script>
    evMapCore = {

        properties: {
            /**
             * Initial map center
             */
            initialCenter: {
                type: Array,
                value: [140860.69299028325, 190532.7165957574]
            },
            /**
             * Extent of Flanders
             */
            mapExtent: {
                type: Array,
                value: [9928.000000, 66928.000000, 272072.000000, 329072.000000]
            },
            /**
             * OpenLayers map object
             */
            olMap: {
                type: Object
            },
            tileLayer: {
                type: Object
            }
        },

        createMap: function () {
            var self = this;
            var view = this.getView();
            this.olMap = new ol.Map({
                target: this.$map,
                loadTilesWhileAnimating: true,
                interactions: ol.interaction.defaults({mouseWheelZoom:false}),
                controls: [
                    new ol.control.ScaleLine(),
                    new ol.control.Zoom(),
                    new ol.control.ZoomSlider()
                ],
                view: view
            });
            this.tileLayer = this.getTileLayer();
            this.olMap.addLayer(this.tileLayer);
            this.scopeSubtree(this.$map, true);
            this.fire('mapCreated', this.olMap);
        },

        getView: function () {
            return new ol.View({
                center: this.initialCenter,
                extent: this.mapExtent,
                projection: this.getProjection(),
                resolutions: this.getResolutions(),
                zoom: 2
            });
        },

        getProjection: function () {
            if (!ol.proj.get('EPSG:31370')) {
                var code = 'EPSG:31370';
                var definition = '+proj=lcc +lat_1=51.16666723333333 +lat_2=49.8333339 +lat_0=90 +lon_0=4.367486666666666 +x_0=150000.013 +y_0=5400088.438 +ellps=intl +towgs84=106.869,-52.2978,103.724,-0.33657,0.456955,-1.84218,1 +units=m +no_defs';
                proj4.defs(code, definition);
            }
            return ol.proj.get('EPSG:31370');
        },

        getResolutions: function () {
            var resolutions = [];
            var maxResolution = ol.extent.getHeight(this.mapExtent) / 256;
            for (var i = 0; i < 12; i++) {
                resolutions[i] = maxResolution / Math.pow(2, i);
            }
            return resolutions;
        },

        getMatrixIds: function () {
            var ids = [];
            for (var i = 0; i < 12; i++) {
                ids[i] = i.toString();
            }
            return ids;
        },

        getTileLayer: function () {
            return new ol.layer.Tile({
                name: 'tiles',
                source: new ol.source.WMTS({
                    url: 'https://tile.informatievlaanderen.be/ws/raadpleegdiensten/wmts',
                    layer: 'grb_bsk_grijs',
                    matrixSet: 'BPL72VL',
                    format: 'image/png',
                    projection: 'EPSG:31370',
                    tileGrid: this.getTileGrid(),
                    style: ''
                })
            });
        },

        getTileGrid: function () {
            return new ol.tilegrid.WMTS({
                extent: this.mapExtent,
                resolutions: this.getResolutions(),
                matrixIds: this.getMatrixIds()
            });
        },

        isFeatureClick: function (event, name) {
            var pixelPoint = event.pixel;
            var result = false;
            this.olMap.forEachFeatureAtPixel(pixelPoint, function(feature, layer) {
                if (!name || feature.get('name') === name) {
                    result = true;
                    return true;
                }
            });
            return result;
        },

        getFeaturesAtPixel: function (pixelPoint, name) {
            var result = [];
            this.olMap.forEachFeatureAtPixel(pixelPoint, function(feature, layer) {
                if (!name || feature.get('name') === name) {
                    result.push(feature);
                }
            });
            return result;
        }

    }
</script>
